<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Swagger UI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swagger-ui-dist@5.19/swagger-ui.css" />
</head>

<body>
  <div id="swagger-ui"></div>
  <script src="https://cdn.jsdelivr.net/npm/swagger-ui-dist@5.19/swagger-ui-bundle.js"></script>
  <script>
    const ui = SwaggerUIBundle({
      url: '/openapi.json',
      dom_id: '#swagger-ui',
      presets: [SwaggerUIBundle.presets.apis],
      layout: "BaseLayout",
      tryItOutEnabled: true,            // enable "Try it out"
      requestInterceptor: (req) => {
        // Example: add an Authorization header automatically.
        // req.headers['Authorization'] = 'Bearer <token>';
        return req;
      }
    });
    const evtSource = new EventSource("/events");
    evtSource.addEventListener('update', async (e) => {
      console.log('update event:', e.data);
      try {
        const res = await fetch('/openapi.json', { cache: 'no-store' });
        const spec = await res.json();

        window.ui.specActions.updateSpec(spec);
        window.ui.specActions.download();
      } catch (err) {
        console.error('Failed to reload swagger spec', err);
      }
    });
    evtSource.onerror = err => {
      console.warn('SSE Error', err);
    };

    window.ui = ui;
    window.evtSource = evtSource;
  </script>
</body>

</html>